<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
 
    <title>suivi de stock</title>
    <style>
   body {
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
            margin: 0;
            padding: 0;
            background-color: #e0f2f1;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #004d40;
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin: 5px 0 5px;
            font-weight: bold;
        }
        input, select {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 5px 0 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            
        }
        button {
            padding: 12px 20px;
            background-color: #004d40;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #00332b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #004d40;
            color: #ffffff;
            position: sticky;
            top: 0;
        }
        input[type="search"] {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Courier New', Courier, monospace;
        }
        #data-entry-form {
            display: none;
            margin-top: 20px;
        }
        #data-entry-form input,
        #data-entry-form select {
            margin-bottom: 15px;
        }
        #data-entry-form button {
            margin-right: 10px;
        }
        #form-container {
            display: flex;
            justify-content: space-between;
        }
        #sum-container {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center;">SUIVI DE STOCK FINCA 20</h1>

    <label for="sheet-select">Select Google Sheet:</label>
    <select style="font-weight: bold;" id="sheet-select">
        <option style="font-weight: bold;" value="https://script.google.com/macros/s/AKfycbw55__9PXFaW1rYOuue-obfG8rFGw4JYYrKjW8hWusYZOIsmWijRkD3gzVpOr8wC9Vz/exec">CINTA</option>
        <option style="font-weight: bold;" value="https://script.google.com/macros/s/AKfycbwajMkUc5GtNpM37RV-6fxzBss4gLTbnxqjUf5craGQWFtl0xtuow_7rTaCaH048_EL/exec">PAILLAGE</option>
        <option style="font-weight: bold;" value="https://script.google.com/macros/s/AKfycbyLDC33PEmZhOXqAtcc0BTzcEmpAiypTwKiGENLHBw8jDXxbz2ZVxodFWPjII2Ak-xw/exec">FILE DE FER</option>
    </select>

    

    <button id="show-form-btn">Add Data</button>

    <div id="form-container">
        <form id="data-entry-form">
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required>

            <label for="stock-initial">Stock Initial:</label>
            <input type="number" id="stock-initial" name="stockInitial" required>

            <label for="entree">Entree:</label>
            <input type="text" id="entree" name="entree" >

            <label for="sortie">Sortie:</label>
            <input type="text" id="sortie" name="sortie" >

            <label for="stock-final">Stock Final:</label>
            <input type="number" id="stock-final" name="stockFinal" readonly>

            <label for="observation">Observation:</label>
            <input type="text" id="observation" name="observation">

            <button type="submit">Submit</button>
            <button type="button" id="hide-form-btn">Cancel</button>
        </form>
    </div>

    <h2 style="text-align: center; font-weight: bold;" id="table-title">Selected Sheet: Sheet 1</h2>

    <div style="text-align: center;" id="sum-container">Total entree: <span id="sumColumn3">0</span> :::::::::::::::: Total sortie: <span id="sumColumn4">0</span> :::::::::::::::: Difference <span id="v2">0</span></div>

    <table id="data-table">
        <thead>
            <tr></tr>
        </thead>
        <tbody>
            <!-- Table rows will be dynamically inserted here -->
        </tbody>
    </table>
</div>

<script>
    let currentSheetUrl = '';
    let currentSheetName = '';

    document.getElementById('sheet-select').addEventListener('change', function() {
        currentSheetUrl = this.value;
        currentSheetName = this.options[this.selectedIndex].text;
        document.getElementById('table-title').textContent = `FICHE DE STOCK : ${currentSheetName}`;
        loadLastStockFinal();
        loadTableData();
    });

    function calculateStockFinal() {
        const stockInitial = Number(document.getElementById('stock-initial').value) || 0;
        const entree = Number(document.getElementById('entree').value) || 0;
        const sortie = Number(document.getElementById('sortie').value) || 0;
        const stockFinal = stockInitial + entree - sortie;
        document.getElementById('stock-final').value = stockFinal;
    }

    document.getElementById('entree').addEventListener('input', calculateStockFinal);
    document.getElementById('sortie').addEventListener('input', calculateStockFinal);

    function loadLastStockFinal() {
        if (!currentSheetUrl) return;
        fetch(`${currentSheetUrl}?getData=true`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                alert(data.message);
                return;
            }
            const lastRow = data.data[data.data.length - 1];
            const lastStockFinal = lastRow[lastRow.length - 2];
            document.getElementById('stock-initial').value = lastStockFinal;
            calculateStockFinal(); // تحديث stock-final عند تحميل آخر قيمة للمخزون النهائي
        });
    }

    document.getElementById('data-entry-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentSheetUrl) {
            alert('Please select a Google Sheet.');
            return;
        }

        const data = {
            date: document.getElementById('date').value,
            stockInitial: document.getElementById('stock-initial').value,
            entree: document.getElementById('entree').value,
            sortie: document.getElementById('sortie').value,
            stockFinal: document.getElementById('stock-final').value,
            observation: document.getElementById('observation').value
        };

        fetch(currentSheetUrl, {
            method: 'POST',
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            alert('Data submitted successfully!');
            loadTableData();
            document.getElementById('data-entry-form').style.display = 'none'; // إخفاء النموذج بعد الإرسال
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    });

    function loadTableData() {
        if (!currentSheetUrl) return;
        fetch(`${currentSheetUrl}?getData=true`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                alert(data.message);
                return;
            }
            const tableHead = document.getElementById('data-table').querySelector('thead');
            const tableBody = document.getElementById('data-table').querySelector('tbody');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            const headRow = document.createElement('tr');
            data.data[0].forEach((cell, index) => {
                const th = document.createElement('th');
                th.textContent = cell;
                const searchInput = document.createElement('input');
                searchInput.type = 'search';
                searchInput.placeholder = 'Search...';
                searchInput.addEventListener('input', () => {
                    filterTable(index, searchInput.value);
                });
                th.appendChild(searchInput);
                headRow.appendChild(th);
            });
            tableHead.appendChild(headRow);

            data.data.slice(1).forEach(row => {
                const tr = document.createElement('tr');
                row.forEach((cell, index) => {
                    const td = document.createElement('td');
                    td.textContent = index === 0 ? formatDate(cell) : cell;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            updateColumnSums(); // تحديث مجموع الأعمدة بعد تحميل البيانات
        });
    }

    function formatDate(value) {
        const date = new Date(value);
        return isNaN(date.getTime()) ? value : `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
    }

    function filterTable(columnIndex, searchTerm) {
        const rows = document.querySelectorAll('#data-table tbody tr');
        searchTerm = searchTerm.toLowerCase();
        rows.forEach(row => {
            const cell = row.cells[columnIndex].textContent.toLowerCase();
            row.style.display = cell.includes(searchTerm) ? '' : 'none';
        });
        updateColumnSums(); // تحديث مجموع الأعمدة عند تغيير الفلتر
    }

    function updateColumnSums() {
        const rows = document.querySelectorAll('#data-table tbody tr');
        let sumColumn3 = 0;
        let sumColumn4 = 0;

        rows.forEach(row => {
            if (row.style.display !== 'none') { // تأكد من حساب الصفوف غير المخفية فقط
                const column3Value = parseFloat(row.cells[2].textContent) || 0;
                const column4Value = parseFloat(row.cells[3].textContent) || 0;
                sumColumn3 += column3Value;
                sumColumn4 += column4Value;
            }
        });
        const v2 = sumColumn3 -sumColumn4;
        document.getElementById('sumColumn3').textContent = sumColumn3.toFixed(2);
        document.getElementById('sumColumn4').textContent = sumColumn4.toFixed(2);
        document.getElementById('v2').textContent = v2.toFixed(2);
    }

    document.getElementById('show-form-btn').addEventListener('click', () => {
        document.getElementById('data-entry-form').style.display = 'block';
    });

    document.getElementById('hide-form-btn').addEventListener('click', () => {
        document.getElementById('data-entry-form').style.display = 'none';
    });

    document.addEventListener('DOMContentLoaded', function() {
        // تعيين ورقة العمل الافتراضية عند تحميل الصفحة
        document.getElementById('sheet-select').dispatchEvent(new Event('change'));
    });
</script>
</body>
</html>
